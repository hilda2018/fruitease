<!doctype html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" charset="utf-8" />
    <title>水果通服务平台</title>
    <link href="../lib/css/easyui.css" rel="stylesheet" type="text/css" />
    <!---oheng css -->
    <link href="../css/oheng.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
        html,body{margin:0;height:100%}#main{height:100%;margin:0 10px 0 160px}#left,#right{width:160px;height:100%;position:relative}#right{width:6px}       
  
        
           #left{float:left}#right{float:right}#warningContainer{position:absolute;left:10px;right:0;font-size:12px;top:16px;bottom:0;width: 150px;overflow: auto;}
        .datagrid-cell input[type=checkbox]{position:absolute!important;clip:rect(0,0,0,0)!important;/* IE8+ */ *left:-999px!important;}
        .expandCls{left:20px!important;transition:0.5s all;}
   .gridBodyClsWithTitle,.gridTitleCls{transition:0.5s all;}
   
   .easyui-dialog .gridBodyClsWithTitle{
   overflow: hidden!important;
    border: 1px solid #eee;
    box-sizing: border-box;
    }
    .left60{left:56px;}
   #left.showExpand
   {
       
       width:60px!important;}
        #left.showExpand  #warningContainer{display:none;}
.gridBodyClsWithTitle .datagrid-view2 .datagrid-header,.gridBodyClsWithTitle .datagrid-view2  .datagrid-body{width:100%!important;}
 
  
.datagrid-body .datagrid-editable{margin:0 8px;}
   .zbDateInput,  .ycyycancle,  .zbrInput{border:0!important;cursor:pointer;background:transparent;width:80px!important;margin-left: -6px!important;}
     .yccancle,.wxsend{    cursor: pointer;
    height: 16px;
    width: 16px!important;
    padding: 0!important;}
    .datagrid-view {
    width: 100%!important;
}
.menuSection ul {
    display: none;
}
.showOr ul {
    display: block!important;
}
.datagrid-view2
{
    width:100%!important
    }
    .ycyyBtnSelect{color:red;position:relative;}
    </style>
</head>
<body>
     <div id="left">
          <!---菜单-->
   
   <a id="btnEffect" href="javascript:;" class=""> <span class="left">&lt;&lt;</span><span class="right">&gt;&gt;</span> </a>
    <div id="warningContainer"></div>
   </div>
        <div id="main">
   <div id="center">
   
           <!---搜索项 -->
        <div class="fix" id="topList">
            <form id="ohForm" class="mt2em">
                <div class="inline_block mr1em mb1em">
                    <a id="helpDocument" href="javascript:;" class="form_a">
                        <i class="icon-help icon_"></i>
                        <span class="mrHalfem">帮助文档</span></a>
                </div>
                <div class="inline_block mr1em mb1em">
                    <a id="reloadWindow" href="javascript:;" class="form_a">
                        <i class="icon-reload icon_"></i>
                        <span class="mrHalfem">刷新</span></a>
                </div>
                <div class="inline_block mr1em mb1em">
                    <label class="mrHalfem">业务编号</label>
                    <input name="ywbh" class="ui-input w100" /></div>
                <div class="inline_block mr1em mb1em">
                    <label class="mrHalfem">人员</label>
                    <input class="ui-input w100" name="ry" /></div>
                <div class="inline_block mr1em mb1em">
                    <label class="mrHalfem">预警内容</label>
                    <input class="ui-input w100" name="yjnr" /></div>
                <div class="inline_block mr1em mb1em">
                    <label class="mrHalfem">接单人</label>
                    <select class="ui-input w200" name="jdrjc" id="jdrjc"></select>
                </div>
                <div class="inline_block mr1em mb1em">
                    <label class="mrHalfem">是否勾选</label>
                    <select class="easyui-combobox ui-input"   name="sfgx" style="width:100px;" data-options="panelWidth:100,panelHeight:190">   
                        <option value="">全部</option>
                        <option value="Y">已勾选</option>
                        <option value="N">未勾选</option>
                    </select>
                </div>
                <div class="inline_block mr1em  mb1em">
                    <a id="ycyy" class="ui-button  ui-button-primary" role="button">异常原因</a>
                </div>
                <div class="inline_block mr1em  mb1em">
                    <a id="filterFunc" class="ui-button ui-button-primary">查询</a>
                </div>
            </form>
        </div>

    
            <!---表格 -->
        <table id="tableDataGrid" ></table>


   
   </div>

   <div id="right"></div>
  </div>

    <!--region  图标 --->
    <div class="dn">
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1">
            <symbol id="icon-menu" style="width: 12px; height: 12px;vertical-align: middle;fill: currentColor;overflow: hidden;"
                viewBox="0 0 1024 1024">
                <path d="M933.647059 632.470588v301.176471H632.470588V632.470588h301.176471m90.352941-90.352941H542.117647v481.882353h481.882353V542.117647zM391.529412 632.470588v301.176471H90.352941V632.470588h301.176471m90.352941-90.352941H0v481.882353h481.882353V542.117647z"
                    fill="#5490D6" p-id="1290"></path>
                <path d="M933.647059 90.352941v301.176471H632.470588V90.352941h301.176471m90.352941-90.352941H542.117647v481.882353h481.882353V0z"
                    fill="#A3CCFA" p-id="1291"></path>
                <path d="M391.529412 90.352941v301.176471H90.352941V90.352941h301.176471m90.352941-90.352941H0v481.882353h481.882353V0z"
                    fill="#5490D6" p-id="1292"></path>
            </symbol>
            <symbol id="icon-item" style="width: 1em; height: 1em;vertical-align: middle;fill: #666;overflow: hidden;"
                viewBox="0 0 1024 1024">
                <path d="M640 531.594375 640 507.957508C640 500.566777 637.388765 493.488982 632.758149 488.328358L488.758149 327.846474C473.554922 310.903123 448 323.21039 448 347.475624L448 401.280597C448 408.783818 450.69108 415.959288 455.446031 421.134624L544 517.433276 456.554212 602.044271C451.131007 607.254361 448 614.936177 448 623.031728L448 676.52569C448 700.127718 472.363314 712.702835 487.864276 697.101619L631.864276 552.170308C637.036445 546.964689 640 539.469607 640 531.594375Z"
                    p-id="5210"></path>
            </symbol>
            <symbol id="icon-circle" style="width: 1em; height: 1em;vertical-align: middle;fill: #666;overflow: hidden;"
                viewBox="0 0 1024 1024">
                <path d="M512.5 622.5c-60.8 0-110-49.2-110-110s49.2-110 110-110 110 49.2 110 110-49.2 110-110 110z"
                    p-id="6515"></path>
            </symbol>
        </svg>
    </div>
    <!--end region  图标 --->

    <!--region  确认关闭弹窗 --->
    <div class="hide" id="confirmDialog"></div>
    <!--end region  确认关闭弹窗 --->

    <!--region  工具按钮 --->
    <div id="ycyyToolbar" class="hide toolbar-cls">
        

      

      <a href="javascript:void(0)" class="easyui-linkbutton btn-cell" iconcls="icon-save" plain="true" id="saveData">存盘</a>
      <span class="btn-cell">|</span>

      <a href="javascript:void(0)" class="easyui-linkbutton  btn-cell" iconcls="icon-add" plain="true" id="addRow">新增</a>
      <span class="btn-cell">|</span>

      <a href="javascript:void(0)" class="easyui-linkbutton btn-cell" iconcls="icon-undo" plain="true" id="cancle">撤销</a>
  <span class="btn-cell">|</span>
      <a href="javascript:void(0)" class="easyui-linkbutton btn-cell" iconcls="icon-remove" plain="true" id="closeDialog">关闭</a>

    </div>
    <!--region  工具按钮--->


    <!--region  输入异常原因对话框 弹窗--->
    <div id="ycyyInputTable" class="easyui-dialog" title="输入异常原因" data-options="closed:true">
  
            <table id="yjlxTableDataGrid"></table> 

    </div>
    <!--region  输入异常原因对话框 弹窗--->
    <div id="ycyySelectList" title="异常类型下拉选择" class="easyui-dialog" data-options="closed:true,border:false,cls:'Cls',height:200,width:400">
            <table id="yjlxListDataGrid" ></table>
    </div>
    <!--end  region  输入异常原因对话框 弹窗--->

    <script type="text/javascript" src="../lib/js/jqueryAndeasyuiAndjson.js"></script>


    <script type="text/javascript" >

    
        var userName = $(window.top.document.getElementById("userName")).text();
        var baseUrl = window.location.origin + "/IFView/IndexHandler.ashx";


        var ajaxPost = function (url, data, success, error) {

            $.ajax({
                type: 'post',
                url: url,
                data: data,
                dataType: 'json',
                success: function (data) {
                    if (success) { success(data); }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    if (!error) { return false; }
                    error({
                        jqXHR: jqXHR,
                        textStatus: textStatus,
                        errorThrown: errorThrown
                    });
                }
            });
        };


        var main = {
            "yjxxMenuData": [],
            "ycyyAddData":{}
        };

        /**************************menu**************************/
        var $menuContainer = $('#warningContainer');
        var $gridDiv = $('#tableDataGrid');
        var $listGridDiv = $("#yjlxListDataGrid");
        var $tableGridDiv = $("#yjlxTableDataGrid");
        var formatData = function (dataArr, index) { //对后台传过来的数据进行修造
            var origin = dataArr && dataArr.rows;
            if (!(origin && origin.length)) {
                return false;
            }
            var menuItems = [];
            $.each(origin,
                function (i) {

                    menuItems.push({
                        "yjlxmc": origin[i].yjlxmc ? $.trim(origin[i].yjlxmc) : "",
                        "yjlxbh": origin[i].yjlxbh ? origin[i].yjlxbh : "",
                        "IsLast": origin[i].IsLast ? origin[i].IsLast : "",
                        "syjbh": origin[i].syjbh ? origin[i].syjbh : "",
                        "xh": origin[i].xh ? origin[i].xh : "",
                        "parentIndex": index ? index : "",
                        "menuData":[],
                        "selfIndex": i
                    });

                });
            return menuItems;
        };

        // 第一次 初始化菜单       参数设置

        var menuParams = { "action": "GetWarningMenuList", "parentId": "00" };   // 请求参数
        var menuHandler = function (initData) {    // 处理函数

            $menuContainer.data("data", initData);
            var menuItems = main.yjxxMenuData = formatData(initData);

            if (!menuItems && menuItems[0]) { return false; }

            var strhtml = "";
            var tophtml = "";
            for (var iItem = 0; iItem < menuItems.length; iItem++) {

                var item = menuItems[iItem];
                if (item && item.yjlxbh && item.yjlxbh === "00") {
                    tophtml = '<div data-syjbh="' + item.syjbh + '"   class="menuTopTitle menuListTitle" data-id="' + item.yjlxbh + '"    id="' + item.yjlxbh + '"  ><i class="icon icon-menu"><svg><use xlink:href="#icon-menu"></use></svg></i><i>' +
                item.yjlxmc + '</i>' + '</div> ';
                } else {
                    strhtml += '<div class="menuSection"> <div class="menuListTitle"  data-syjbh="' + item.syjbh + '"  data-id="' + item.yjlxbh + '"  ><i class="icon icon-item"><svg><use xlink:href="#icon-item"></use></svg></i><i>  ' +
                item.yjlxmc + '</i> </div> <ul data-syjbh="' + item.syjbh + '"   class="hide  subMenu"    data-id="' + item.yjlxbh + '"  id="' +
                item.yjlxbh + '"  ></ul>  </div>';
                }
            }

            $menuContainer.html(tophtml + strhtml);
            //  初次加载全部数据
            $('.menuTopTitle').addClass('activeMenuListTitle');

        };



        // 接单人请求
        $('#jdrjc').combobox({
            url: baseUrl + "?action=GetJdrData",
            valueField: 'khjc',
            panelWidth:160,
            panelHeight:200,
            textField: 'khjc',
            loadFilter: function (data) {
                data.rows.unshift({ "khjc": "全部" });
                return data.rows;
            }
        });
        $('#jdrjc').combobox('setValue', '全部');



        // 给一级菜单绑定 点击事件
        $(document).delegate('.menuListTitle', 'click', function (e) {


            var $this = $(this);
            $(".menuListTitle").removeClass("activeMenuListTitle");
            $this.toggleClass("activeMenuListTitle");
           $this.parent().toggleClass("showOr");
            if (e.currentTarget.id === "00") {
                //全部 菜单触发
              $gridDiv=  $gridDiv.datagrid('reload', { "yjlxbm": "00" + '', "page": "1", "rows": "200", "action": "GetTableData" });
                return false;
            }



            if ($this.data("data")) { // 判断是否请求过数据  //已经初始化  
                console.log($this.data("data"));
                console.log("已经初始化");
                return false;
            }

            //未初始化发起，ajax 请求，渲染二级菜单
            var $thisParent = $this.parent();
            var index = $thisParent.index()-1;

            $thisParent.find('ul').toggleClass("hide");
            var id = $this.attr("data-id");
            if (!id) {
                $.messager.alert("提示", "系统出错：" + errorMsg);
            }

            var subMenuParms = {
                "action": "GetWarningMenuList",
                "parentId": id
            };

            var subMenuHandler = function (menuData) {
                $this.data("data", menuData);
                //防止多次请求     初始化数据 次级菜单
                main.yjxxMenuData[index].menuData = formatData(menuData, index);
                console.log(main.yjxxMenuData[index].menuData);
                main.yjxxMenuData[index].hasInit = true; // 初始化
                // 将求得的二级菜单数据变为html 
                var subData = main.yjxxMenuData[index].menuData;
                /***** 生成子菜单 ********/
                if (!subData && !subData.length) { return false; }
                var submenuHtml = "";

                $.each(subData, function (i, item) {
                    submenuHtml += '<li  data-syjbh="' + item.syjbh + '"   data-id="' + item.yjlxbh + '" id="' + item.yjlxbh + '"   class="' + item.syjbh + ' theLastItem"   ><i class="icon icon-circle"><svg><use xlink:href="#icon-circle"></use></svg></i><i> ' + item.yjlxmc + '<i></li>';
                });
                var $subObj = $('#' + subData[0]["syjbh"]);
                $subObj.html(submenuHtml);
                $subObj.delegate('.theLastItem', 'click', function (e) {

                    var $taerget = $(e.currentTarget);
                    $(".activeTheLastItem").removeClass("activeTheLastItem");
                    $taerget.addClass("activeTheLastItem");
                    var yjlxbm = $taerget.attr("id");
                    if (yjlxbm === "00") {
                      $gridDiv=  $gridDiv.datagrid('reload', { "yjlxbm": "00" + '', "page": "1", "rows": "200", "action": "GetTableData" });
                        return false;
                    }

                    $gridDiv.datagrid('reload', { "yjlxbm": yjlxbm, "page": "1", "rows": "200", "action": "GetTableData" });
                  
   
                    return false;
                });

            };
            //  点击一级菜单  发起请求
            ajaxPost(baseUrl, subMenuParms, subMenuHandler);

        });


        /***********************end***menu**************************/


        // 初始化datagrid    参数设置
        var gridDivOptions = {
            "toolbar": "#topList",
            "url": baseUrl,
            "title":"预警信息查询",
            "headerCls": 'gridTitleCls  left160',
            "bodyCls": 'gridBodyClsWithTitle left160',
            dataType: "json",
            queryParams: {
                "yjlxbm": "00",
                "action": "GetTableData",
                "page": 1,
                "rows": 200
            },
            "columns": [
            [{
                sortable: false,
              checkbox: true,
                field: "yj1xbm", 
                width: 20,
                title: "预警类型编码"
            },
                {
                    sortable: false,
                    field: "rownumber",
                    title: "序号",
                    align: "center",
                    width: 40
                },
                {
                    sortable: false,
                    field: "ry",  
                    width: 0,
                    title: "用户名",
                    hidden: true
                },
                {
                    sortable: false,
                    field: "xh",
                    width: 0,
                    title: "序号",
                    hidden: true
                },
                {
                    sortable: false,
                    field: "sfhys",
                    width: 0,
                    title: "是否是红颜色",
                    hidden: true
                },
         
                {
                    sortable: false,
                    field: "yjlxmc",
                    width: 80,
                    title: "预警类型"
                },
                {
                    sortable: false,
                    field: "ywbh",
                    width: 80,
                    title: "编号"
                },
                {
                    sortable: false,
                    field: "hth",
                    title: "合同号"
                },
                {
                    sortable: false,
                    field: "yjsj",
                    title: "预警时间"
                },
                {
                    sortable: false,
                    field: "jsq",
                    width: 80,
                    title: "计时器"
                },
                {
                    sortable: false,
                    field: "rymc",
                    width: 50,
                    title: "人员"
                },
                {
                    sortable: false,
                    field: "yjnr",
                    title: "预警内容"
                },
                {
                    sortable: false,
                    field: "ycd",
                    width: 80,
                    title: "原产地",
                    align: 'center'
                },
                {
                    sortable: false,
                    field: "sp",
                    width: 80,
                    title: "商品",
                    align: 'center'
                },
                {
                    sortable: false,
                    field: "xq",
                    width: 80,
                    title: "详情",
                    align: 'center'
                },
                {
                    sortable: false,
                    field: "qzyj",
                    width: 80,
                    title: "前置预警"
                },
                {
                    sortable: false,
                    field: "jdrjc",
                    width: 100,
                    title: "接单人"
                },
                {
                    sortable: false,
                    field: "sfyycyy",
                    width: 100,
                    title: "是否有异常原因",
                    align: 'center',
                    formatter: function (value, row, index) {

                        var temAttr = (value === "N" ? '' : 'checked ');
                        return '<input disabled type="checkbox"  ' +
                            temAttr +
                            ' id="checkbox' +
                            index +
                            '"  name= "checkbox"> <label for="checkbox' +
                            index +
                            '"  class="ui-checkbox"></label><label for="checkbox' +
                            index +
                            '" ></label>';
                    }
                },
                {
                    field: "sfgx",
                    width: 80,
                    title: "是否勾选",
                    align: 'center',
                    formatter: function (value, row, index) {

                        var temAttr = (value === "N" ? '' : 'checked ');
                        return '<input disabled type="checkbox"  ' +
                            temAttr +
                            ' id="sfgx_checkbox' +
                            index +
                            '"  name="checkbox"> <label for="sfgx_checkbox' +
                            index +
                            '"  class="ui-checkbox"></label><label for="sfgx_checkbox' +
                            index +
                            '" ></label>';

                    }
                }
            ]
        ],
            "nowrap": true,
            fit: true,
            rownumbers: false,
            singleSelect: true,
            idField: "ry",
            halign: "center",
            border: false,
            onBeforeLoad: function () {
                console.log('beforeload');
            },
            loadFilter: function (data) {
                if (data.rows && data.result) {

                } else {
                    alam(data.msg);
                }

                return data;
            },
            onLoadSuccess: function (data) {

             
            },
            onLoadError: function (data) {

              
            },
            onSelect:function(rowIndex, row){
                main.ycyyAddData.yjlxbm = row.yjlxbm;
               main.ycyyAddData.ywbh = row.ywbh;
     
                if(!$listGridDiv.intGrid){
                   $listGridDiv =  $listGridDiv.edatagrid( listGridOptions(row.yjlxbm));
                   $listGridDiv.initCrid =true;
                }else{
                          $listGridDiv.edatagrid('load',{
                       "yjlxbh": row.yjlxbm, 
                        "action": "GetYcyyListData"
                   
                   });   $listGridDiv.edatagrid('disableEditing');
                }
                
           
                   if(!$tableGridDiv.intGrid){
                 $tableGridDiv =  $tableGridDiv.edatagrid( tableGridOptions(row.ywbh,row.yjlxbm));
                 $tableGridDiv.intGrid=true;
                }else{
                   $tableGridDiv.edatagrid('load',{
                      "yjlxbh": row.yjlxbm,    "ywbh": row.ywbh,
                        "action": "GetYcyyTableData"
                   
                   });
                         $tableGridDiv.edatagrid('disableEditing');
               }
            },
            resizable: true,
            striped: true,
            width: "100%",
            height: "600",
            pagination: true,
            pageNumber: 1,
            pageSize: 200,
            pageList: [200, 400, 600, 800, 1000]
        };




    var  $ycListDialog = $('#ycyySelectList');
    var  $ycTableDialog = $('#ycyyInputTable');

   
            var baseOptions = {
                nowrap: true,
                rownumbers: true,
                resizable: true,
                striped: true,
                "headerCls": 'gridTitleCls',
                "bodyCls": 'gridBodyClsWithTitle',
                url: baseUrl,
                singleSelect: true,
                halign: "center",
                border: false
            };

            var listGridOptions = function(yjlxbh) {
                var op = {
                    height: 200,
                    title: "",
                    width: 400,
                    columns: [
                        [
                            {
                                sortable: false,
                                field: "ycyybm",
                                title: "编码",
                                width: 50
                            },
                            {
                                sortable: false,
                                field: "ycyymc",
                                title: "异常原因名称",
                                width: 160,
                                formatter: function(value, row, index) {
                                    return '<span title="' + value + '">' + value + '</span>';
                                }
                            },
                            {
                                sortable: false,
                                field: "ycyylb",
                                title: "异常原因类别",
                                width: 80
                            },
                        ]
                    ],
                    queryParams: {
                        "yjlxbh": yjlxbh ? yjlxbh : '',
                        "action": "GetYcyyListData"
                    },
                    onSelect: function(rowIndex, rowData) {

                        //回写数据到 异常原因 表格
           console.log(rowData);
               
                        main.ycyyAddData.sfwx = rowData.sfwx || rowData.sfwx =='N'?'N':'Y';
                        main.ycyyAddData.ycyymc =rowData.ycyymc;    
                        main.ycyyAddData.yjlxbm =yjlxbh;
                        main.ycyyAddData.ycyybm = rowData.ycyybm;
         
                       $tableGridDiv =  $tableGridDiv.edatagrid('updateRow',{
	                        index:$tableGridDiv.edatagrid('options').editIndex,
	                        row: {
                                "ycyymc":rowData.ycyymc
                            }}
                        );



                        $('#ycyySelectList').dialog('close');

                    }
                };

               return $.extend({}, op, baseOptions) ;
             
        };




        var tableGridOptions = function(ywbh,yjlxbh ) {
            var op = {
               height:500,
               editing:false,
               ediIndex:-1,
                showFooter: false,    
                border: true,
                onBeforeClose: function() {
           
                  $('#addYcyy').removeClass('disabled');
              
                },
                width: '100%',
                toolbar: "#ycyyToolbar",
                columns: [
                    [{
                            sortable: false,
                            field: "isNew",
                            title: "isNew",
                            width: 0,
                            hidden: true,
                        },{
                            sortable: false,
                            field: "yjlxbm",
                            title: "预警类型编码",
                            width: 0,
                            hidden: true,
                        },
                        {
                            sortable: false,
                            field: "id",
                            title: "id",
                            width: 0,
                            hidden: true,
                        },
                        {
                            sortable: false,
                            field: "zbr",
                            title: "制表人",
                            width: 50,
                             editor: {
                                type: 'text',
                                options: { required: true}
                            }
                        },
                        {
                            sortable: false,
                            field: "ycyymc",
                            title: "异常原因",
                            width: 120,
                            formatter: function(value, row, index) {
                        
	                        
                                if($tableGridDiv.edatagrid('options').editIndex == index ){
                                
                  var str="";
                                        if(!value){
                                            str="请选择异常类型"
                                        }else{
                                            str = value;
                                        }
                                       return "<div class='relative ycyyBtnSelect cursor important'><span >"+str+"</span><i class='ui-select-icon'></i></div>";   
                                
                                
                                }else{
                                
                                return "<span class='ycCls' title="+value+" >"+value+"</span>";
                             
                                }
                            
	                 
                             }
                       
                        },
                        {
                            sortable: false,
                            field: "zbrq",
                            title: "制表日期",
                            width: 80 ,
                             editor: {
                                type: 'text',
                                options: { required: true,readonly:true}
                            }
                        },
                        {
                            sortable: false,
                            field: "beizhu",
                            title: "备注",
                            width: 180,     editor: {
                                type: 'text',
                                options: { required: true}
                            },
                            formatter: function(value, row, index) {


                                if (!row.id && value === '') { // 没id,新增
                                    return '<input class="ui-input beizhu" name="beizhu"  focus />'
                                }
                                return value;
                            }


                        },
                        {
                            sortable: false,
                            field: "ycyyqc",
                            title: "异常原因取消",
                            width: 80,
                           formatter: function(value, row, index) {

                                if(!value){value="N"}

                                var temAttr = (value === "N" ? '' : 'checked ');
                                return '<input disabled type="checkbox"  ' +
                                    temAttr +
                                    ' id="sfgx_checkbox' +
                                    index +
                                    '"  name="checkbox"> <label for="sfgx_checkbox' +
                                    index +
                                    '"  class="ui-checkbox"></label><label for="sfgx_checkbox' +
                                    index +
                                    '" ></label>';

                            }

                        },
                        {
                            sortable: false,
                            field: "ycyyqcsj",
                            title: "异常原因取消时间",
                            width: 80,
                            formatter: function(value, row, index) {
                                
                                if(!value || value=="1900/1/1 0:00:00"){value=''}
                                return '<span class="ycyyqcsjSpan">' + value + '</span>';
                            }
                        },
                        {
                            field: "wxsffs",
                            title: "微信是否发送",
                            width: 80,
                   
                                    formatter: function(value, row, index) {
                                         if(!value){value="N"}
                                var temAttr = (value === "N" ? '' : 'checked ');
                                return '<input disabled type="checkbox"  ' +
                                    temAttr +
                                    ' id="sfgx_checkbox' +
                                    index +
                                    '"  name="checkbox"> <label for="sfgx_checkbox' +
                                    index +
                                    '"  class="ui-checkbox"></label><label for="sfgx_checkbox' +
                                    index +
                                    '" ></label>';

                            }





                        }
                    ]
                ],
                onClickCell:function(rowIndex,field,value){
                  
                   if($tableGridDiv.edatagrid('options').editIndex != rowIndex ){
                   $tableGridDiv.edatagrid('disableEditing');
                    return false;
                   }
                    $tableGridDiv.edatagrid('enableEditing');

                     if(field == 'ycyymc' ){
                     $('td[field="ycyymc"]').find('.ycyyBtnSelect').click(function(){
                        
                     });
                     }
                    if(field == 'ycyyqc' ){

                        if(!value){
                            value="N";
                        }
                        value = value=="N"?"Y":"N";
                        if(value=="Y"){
                   
                          main.ycyyAddData.ycyyqcsj = getTime();
                        }else{
                          main.ycyyAddData.ycyyqcsj = '';
                        }
                             main.ycyyAddData.ycyyqc =value;
                        $(".ycyyqcsjSpan").eq(rowIndex).html( main.ycyyAddData.ycyyqcsj  );
                      
                    }
          
                    if(field == 'wxsffs' ){
                      if(!value){
                            value="N";
                        }

                        value = value=="N"?"Y":"N";
                         main.ycyyAddData.wxsffs = value;
                    }
                    

                     $tableGridDiv.edatagrid('updateRow',{
	                        index: rowIndex,
	                        row:main.ycyyAddData
                        });




                },
                queryParams: {
                    "ywbh": ywbh ? ywbh : '',
                    "yjlxbh": yjlxbh ? yjlxbh : '',
                    "action": "GetYcyyTableData"
                }
                   
            }; 
            return  $.extend({}, op, baseOptions)
        };

var getTime = function() {
    var time = new Date().getFullYear() +
        "/" +
        (new Date().getMonth() + 1) +
        "/" +
        new Date().getDate() +
        " " +
        new Date().getHours() +
        ":" +
        new Date().getMinutes() +
        ":" +
        new Date().getSeconds();
    return time;
},


   // 初始化 dialog

        $ycListDialog = $ycListDialog.dialog({
                height:246,
                width:400,top:30,
                closed: true,
                resizable: true,
                draggable: true,   onOpen: function() {

                $listGridDiv.edatagrid('resize');


                }
        });


           $ycTableDialog = $ycTableDialog.dialog({
                height: 300,top:30,
                cls: 'dialogCls',
                width: 600,
                resizable: true,
                modal: true,
                closed: true,
                minimizable: true,
                collapsible: true,
                minimizable: true,
                maxmizable: true,
                draggable: true,
                onClose:function(){
                  dialogClose();
                },
                onOpen: function() {
                $tableGridDiv.edatagrid('resize');


                }
            });











        //  第一次 初始化菜单  发起请求
        ajaxPost(baseUrl,menuParams,menuHandler);
    
            // 初始化datagrid 
        $gridDiv = $gridDiv.datagrid(gridDivOptions);
    
  

    // 事件的绑定

    $(document).delegate("#btnEffect",'click',function(){
       $('.gridBodyClsWithTitle').add($('.gridTitleCls')).toggleClass('left60 left160');
       $("#left").toggleClass('showExpand');
   
    });
    
$('#ycyy').click(function() {
    $ycTableDialog.dialog('open');

});

        // 事件的绑定  新增
    $(document).delegate("#addRow",
        'click',
        function(e) {

         var selectRow = $gridDiv.edatagrid('getSelected')
            $('#saveData').attr('disabled',false )//保存 按钮可点击
              $(".editCell").eq(0).text(userName);
            var zbrTime = getTime() ;
            $(".editCell").eq(1).val(  zbrTime  ).addClass("zbDateInput").attr({"readonly":true});
           main.ycyyAddData.zbr = userName;
           main.ycyyAddData.zbrq = zbrTime;    main.ycyyAddData.isNew= true;
           main.ycyyAddData.ycyyqcsj = ""; main.ycyyAddData.ycyymc='';
           main.ycyyAddData.ycyyqc = "N";   main.ycyyAddData.ywbh = selectRow.ywbh;
           main.ycyyAddData.yjlxbm = selectRow.yjlxbm;
           main.ycyyAddData.wxsffs = "N";
           main.ycyyAddData.beizhu = "";
            $(this).attr('disabled',true );//新增 按钮可点击
             $tableGridDiv.edatagrid('enableEditing');
	       $tableGridDiv.edatagrid('addRow').edatagrid('updateRow',{
	                        index: $tableGridDiv.edatagrid('options').editIndex,
	                        row:main.ycyyAddData
                        });


    });


    var dialogClose =function(){
     
        $('#addRow').removeClass('disabled');//新增 按钮可点击
        main.ycyyAddData = {};//清空 新增的数据
       $tableGridDiv =  $tableGridDiv.edatagrid('reload');
    }
         // 事件的绑定  关闭
    $(document).delegate("#closeDialog", 'click',
    function() {
       $('#ycyyInputTable').dialog('close');//面板 关闭
    dialogClose();
    });
  


    $(document).delegate("#saveData", 'click',
    function(e) {
 
        $('#saveData').attr('disabled',false);//保存 按钮 不可点击
     
            if (!main.ycyyAddData || !main.ycyyAddData.ycyymc) {
                $.messager.alert('提醒', '必须选择异常原因后，才能进行保存操作', 'alert');
                return false;
            }

            console.log(main.ycyyAddData);

            if (!main.ycyyAddData) {
                $.messager.alert("警告", "必须传相应的数据参数才能进行保存操作", "alert");
                return false;
            }


            var json = main.ycyyAddData;
            var oneItem = {};
            if (json.id) { //如果id 存在
                oneItem = {
                    "action": "SaveYcyy",
                    "json": JSON.stringify(json),
                    "id": json.id
                };
            } else {
                oneItem = {
                    "action": "SaveYcyy",
                    "json": JSON.stringify(json)
                };
            }
          
            //loading 

            
        var Params = oneItem ;   // 请求参数
        var Handler = function (data) {    // 处理函数
                 if (data.result) {
                      $.messager.alert('提示信息', data.msg, 'info');
                      $('#addRow').attr('disabled',false);//新增 可点击
                    } else {
                        $.messager.alert('提示信息', '保存失败，查找后台相关原因', 'info');
                    }
              
                $('#ycyySelectList').dialog('close');//面板 关闭
                $tableGridDiv.edatagrid('disableEditing');  $tableGridDiv.edatagrid('options').editIndex = -1;
                $tableGridDiv.edatagrid('options').editing = false;

                $('#addRow').attr('disabled',false);//新增 可点击
                            $tableGridDiv=       $tableGridDiv.edatagrid('reload',{
                      "yjlxbh": main.ycyyAddData.yjlxbm,    "ywbh": main.ycyyAddData.ywbh,
                        "action": "GetYcyyTableData"
                   
                   });
        }
    
          ajaxPost(baseUrl,Params,Handler);
      

    });
  
        $(document).delegate(".ycyyBtnSelect", 'click',
        function(e) {
        if(!$listGridDiv){
         $listGridDiv= $listGridDiv.edatagrid(listGridOptions( main.ycyyAddData.ycyybm ));

        }
            
            $('#ycyySelectList').dialog('open');
    });


     $('#ycyyInputTable').delegate(".datagrid-row-selected input[name='beizhu']", 'change',function(e) {
        main.ycyyAddData.beizhu = $(this).val();
    });
  

      $(document).delegate("#filterFunc", 'click',
        function() {
        
             var paras = {};
            $.each($('#ohForm').serializeArray(),
                function(i, item) {
                    paras[item.name] = item.value;
                });

            var ywbh = paras["ywbh"]?paras["ywbh"]:'';
            var yjnr = paras["yjnr"]?paras["yjnr"]:'';
            var ry = paras["ry"]? paras["ry"]:'';
            if(paras["jdrjc"]=="全部"){
                var jdrjc = "";
            }else{
                var jdrjc = paras["jdrjc"]?paras["jdrjc"]:'';
            }
            var sfgx = paras["sfgx"]?paras["sfgx"]:'';

            var yjlxbm = $('.activeMenuListTitle').attr('data-id');

            if ($('.activeTheLastItem').attr('data-id')) {
                yjlxbm = $('.activeTheLastItem').attr('data-id');
            }
           $gridDiv=  $gridDiv.datagrid('reload', { "yjlxbm": yjlxbm, "page": 1, "rows":200, "action": "GetTableData","ywbh":ywbh,"yjnr":yjnr,"ry":ry,"jdrjc":jdrjc,"sfgx":sfgx });
     });
    

    $("#reloadWindow").click(function(){
        window.self.location.href = window.self.location.origin+window.self.location.pathname+"?time="+new Date().getTime();
    });


    </script>
</body>

</html>           