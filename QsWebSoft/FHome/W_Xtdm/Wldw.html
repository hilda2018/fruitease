<!doctype html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="edge" charset="utf-8" />
    <title>水果通服务平台</title>
    <link href="../lib/css/easyui.css" rel="stylesheet" type="text/css" />
    <link href="../lib/css/easyui_animation.css" rel="stylesheet" type="text/css" />
    <link href="../lib/css/easyui_plus.css" rel="stylesheet" type="text/css" />
    <link href="../lib/css/icon.css" rel="stylesheet" type="text/css" />
    <!---oheng css -->
    <link href="../css/oheng.css" rel="stylesheet" type="text/css" />
        <script type="text/javascript" src="../lib/js/jqueryAndeasyuiAndjson.js"></script>
    <script type="text/javascript" src="../lib/js/jquery.insdep-extend.min.js"></script>
    <script type="text/javascript" src="../lib/theme/modern/js/plugin/sea.js"></script>
</head>
<body>
    <table id="dg" toolbar="#toolbar" rownumbers="true"
        fitcolumns="true" singleselect="true">
    </table>
    <div id="toolbar">
      <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true" id="addRow">新增</a>
      <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true" id="editRow">编辑</a>
      <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true" id="deleteRow">删除</a>
      <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" id="saveData">存盘</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true" id="reflesh">刷新</a>

      <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true" id="closePage">关闭</a>
   </div>





    <script type="text/javascript">

        var zdlxData = [{
            label: '国际运费',
            value: '国际运费'
        }, {
            label: '货代服务费用',
            value: '货代服务费用'
        }, {
            label: '海关税金',
            value: '海关税金'
        }];


        var jdrData = [];
        var gsttData = [];

        var baseData = [];

        $.get(window.location.origin + "/IFView/IndexHandler.ashx?action=GetComboboxGsttListData", function (data) { 
          

            $.each(data.rows, function (i, item) {

                var newTemp = {};
                newTemp.key = item.khmc;
                newTemp.text = item.khmc;
                gsttData.push(newTemp);
            });

         if (jdrData.length != 0 && gsttData.length != 0 && baseData.length !=0) 

                    
              init();

            }

       ,"json");


              $.get(window.location.origin + "/IFView/IndexHandler.ashx?action=GetBaseYszdZhszData", function (data) { 
          
      $.each(data.rows, function (i, item) {

                var newTemp = {};
                newTemp.key = item.yhmc;      newTemp.text = item.yhmc;
                newTemp.yw_khbm = item.yw_khbm;
                newTemp.zh = item.zh;
                baseData.push(newTemp);
            });

                     if (jdrData.length != 0 && gsttData.length != 0 && baseData.length !=0) 

                    
              init();

            }
       ,"json");






        $.get(window.location.origin + "/IFView/IndexHandler.ashx?action=GetComboboxJdrjcListData",function (data, status) {


            $.each(data.rows, function (i, item) {

                var newTemp = {};
                newTemp.key = item.khjc;
                newTemp.yw_khbm = item.yw_khbm;
                newTemp.text = item.khjc;
                jdrData.push(newTemp);
            });


            if (jdrData.length != 0 && gsttData.length != 0 && baseData.length !=0) {
              
              init();

       

            }
       


        },"json" );



      

        



// 
        //, editor: { type: 'combobox', options: { required: true, valueField: 'key', textField: 'text', data: jdrData}} 






  
       















       




          
var $grid = null;


$("#addRow").on('click', function() {
    $grid.edatagrid('addRow');
});

$("#deleteRow").on('click', function () {
   $grid.edatagrid('destroyRow');      
});

$("#updateRow").on('click', function () {
   $grid.edatagrid('updateRow'); 
});

$("#reflesh").on('click', function () {
   $grid.edatagrid('reload'); 
});




$("#saveData").on('click', function() {
  kaiguan=true;
   $grid.edatagrid('saveRow');
});

$("#cancle").on('click', function () {
    $grid.edatagrid('cancelRow');
});


  


$.extend($.fn.datagrid.defaults.editors, {
    text: {
        init: function(container, options){
            var input = $('<input type="text" class="datagrid-editable-input editCell">').appendTo(container);
            return input;
        },
        destroy: function(target){
            $(target).remove();
        },
        getValue: function(target){
            return $(target).val();
        },
        setValue: function(target, value){
            $(target).val(value);
        },
        resize: function(target, width){
            $(target)._outerWidth(width);
        }
    }
});
             
         
  var kaiguan =false;


        

function init(){



        
        var baseSetting = {
          "nowrap": true,
          "fit": true,
          "fitColumns": "true",
          "border": false,
          "resizable": true,
          "rownumbers": true,
          "singleSelect": true,
          "striped": true,
          "width": "100%",
          "halign": "center",
        };





  
        
        var columns = [[{
                field: 'keyid',
                title: 'key',
                checkbox: true,
               

            }, {
                field: 'jdrbm',
                title: '编码',
                width: 40,  editor: {
        type: 'text'
                }
            }, {
                field: 'gstt',
                title: '公司抬头',
                width: 200,
                editor: {
                    type: 'combobox',
                    options: {
                        required: true,
                        valueField: 'key',
                        textField: 'text',
                        data: gsttData
                    }
                }
            },
        
            {
                field: 'zdlx',
                title: '账单类型',
                width: 100,
                editor: {
                    type: 'combobox',
                    options: {
                        required: true,
                        valueField: 'label',
                        textField: 'value',
                        data: zdlxData
                    }
                }
            }, {
                field: 'jdrmc',
                title: '接单人名称',
                width: 200,
                editor: {
                    type: 'combobox',
                    options: {
                        required: true,
                        valueField: 'key',
                        textField: 'text',
                        data: jdrData,
                        onSelect: function(rec){    

                        var arrIndex =    $(this).combobox('panel').find('.combobox-item-selected').index();
                         $('.editCell').eq(0).val(jdrData[arrIndex]["yw_khbm"]);

                        }
                    }
                }
            },  {
                field: 'khyh',
                title: '客户银行',
               editor: {
                    type: 'combobox',
                    options: {
                        required: true,
                        valueField: 'key',
                        textField: 'text',
                        data: baseData,
                        onSelect: function(rec){    

                        var arrIndex =    $(this).combobox('panel').find('.combobox-item-selected').index();
//                         var yhmc = baseData[arrIndex]['yhmc'];
//                          var yw_khbm = baseData[arrIndex]['yw_khbm']
//                           var zh = baseData[arrIndex]['zh']
                               $('.editCell').eq(1).val(baseData[arrIndex]["zh"]);
                        }

                    }
                }
            }, {
                field: 'zh',
                title: '账号',
                hidden: true,
                width: 100,
                 editor: {
        type: 'text'
                }

            },  {
                field: 'lxfs',
                title: '联系方式',
                width: 200,
                editor: {
                    type: 'validatebox',
                    options: {
                        required: true
                    }
                }
            }]];

                


        var optionsDataGrid = {
                             "title": "应收账单账号设置",
                            "toolbar": "#toolbar","autoSave":true,
                            "idField":"key_id",
                             "columns": columns,checkOnSelect:true,
          "url": window.location.origin + "/IFView/IndexHandler.ashx?action=GetYszdZhszTableData",
                       "saveUrl": window.location.origin + "/IFView/IndexHandler.ashx?action=SaveYszdZhsz",
                  "updateUrl": window.location.origin + "/IFView/IndexHandler.ashx?action==SaveYszdZhsz",
              "destroyUrl": window.location.origin + "/IFView/IndexHandler.ashx?action=DeleteYszdZhsz",
        
        "onBeforeLoad":function(){
if(kaiguan){
          var index = $grid.edatagrid('options').editIndex;
    if (index === -1) {
        $.messager.alert('提醒', '没有需要保存的数据', 'info');
        return false;
    }
    var bShift = $grid.edatagrid('validateRow', index);
    if (!bShift) {
        $.messager.alert('提醒','数据有误','info');
        return false;
    }
    kaiguan=!kaiguan;
    }
    
    },

                       "onSuccess":function(data){
                          
                     $.messager.alert('消息','存盘成功' ,'info');
                            
                       }, "onError":function(data){
                          
                             $.messager.alert('消息','存盘失败','danger');
                            
                       }
           };




         $grid  =  $("#dg").edatagrid($.extend({},optionsDataGrid,baseSetting ));

    }



    </script>
</body>
</html>
